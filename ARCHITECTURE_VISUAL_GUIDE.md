# Plantonize NotasFiscais - Architecture Visual Guide

## Clean Architecture Layers

```
????????????????????????????????????????????????????????????????
?                    PRESENTATION LAYER                        ?
?                  (Plantonize.NotasFiscais.API)              ?
?                                                              ?
?  ??????????????????  ??????????????????  ????????????????? ?
?  ?  Controllers   ?  ?   Program.cs   ?  ?  Middlewares  ? ?
?  ??????????????????  ??????????????????  ????????????????? ?
?          ?                   ?                    ?         ?
?          ??????????????????????????????????????????         ?
????????????????????????????????????????????????????????????????
                               ? HTTP Requests
                               ?
????????????????????????????????????????????????????????????????
?                    APPLICATION LAYER                         ?
?             (Plantonize.NotasFiscais.Application)           ?
?                                                              ?
?  ????????????????????????????????????????????????????????   ?
?  ?              Business Logic Services                 ?   ?
?  ?  • NotaFiscalService                                ?   ?
?  ?  • FaturaService                                    ?   ?
?  ?  • ImpostoResumoService                             ?   ?
?  ?  • MunicipioAliquotaService                         ?   ?
?  ????????????????????????????????????????????????????????   ?
?          ?                                                   ?
?          ? Uses interfaces from Domain                      ?
?          ?                                                   ?
????????????????????????????????????????????????????????????????
                               ?
                               ?
????????????????????????????????????????????????????????????????
?                      DOMAIN LAYER                            ?
?               (Plantonize.NotasFiscais.Domain)              ?
?                    ? CORE / HEART ?                         ?
?                                                              ?
?  ???????????????????  ????????????????????  ?????????????? ?
?  ?    Entities     ?  ?   Interfaces     ?  ?    Enums   ? ?
?  ?  • NotaFiscal   ?  ? • INotaFiscal... ?  ? • Status...? ?
?  ?  • Fatura       ?  ? • IFatura...     ?  ? • Tipo...  ? ?
?  ?  • Imposto...   ?  ? • IImposto...    ?  ?            ? ?
?  ?  • Municipio... ?  ? • IMunicipio...  ?  ?            ? ?
?  ???????????????????  ????????????????????  ?????????????? ?
?                                                              ?
?         ??  NO DEPENDENCIES ON OTHER LAYERS ??              ?
????????????????????????????????????????????????????????????????
                               ?
                               ? Implements interfaces
                               ?
????????????????????????????????????????????????????????????????
?                  INFRASTRUCTURE LAYER                        ?
?            (Plantonize.NotasFiscais.Infrastructure)         ?
?                                                              ?
?  ????????????????????????????????????????????????????????   ?
?  ?              Data Access Layer                       ?   ?
?  ?  • NotaFiscalRepository                             ?   ?
?  ?  • FaturaRepository                                 ?   ?
?  ?  • ImpostoResumoRepository                          ?   ?
?  ?  • MunicipioAliquotaRepository                      ?   ?
?  ????????????????????????????????????????????????????????   ?
?  ????????????????????????????????????????????????????????   ?
?  ?            External Services                         ?   ?
?  ?  • ServiceBusService                                ?   ?
?  ?  • MongoDbInitializer                               ?   ?
?  ?  • DatabaseSeeder                                   ?   ?
?  ????????????????????????????????????????????????????????   ?
?          ?                                                   ?
?          ?                                                   ?
?  ????????????????????  ????????????????????                ?
?  ?     MongoDB      ?  ?  Azure Service   ?                ?
?  ?                  ?  ?       Bus        ?                ?
?  ????????????????????  ????????????????????                ?
????????????????????????????????????????????????????????????????
```

---

## Dependency Flow

```
???????????????????????????????????????????????????????????????
?                    DEPENDENCY RULE                          ?
?                                                             ?
?    Outer Layers CAN depend on Inner Layers                 ?
?    Inner Layers CANNOT depend on Outer Layers              ?
???????????????????????????????????????????????????????????????

API Layer
   ?
   ???????????> Application Layer
   ?                  ?
   ?                  ???????????> Domain Layer
   ?                                    ?
   ???????????> Infrastructure ??????????
                   (DI only)      (implements)
```

---

## Request Flow Example

### Creating a Nota Fiscal

```
1. HTTP Request
   ??????????????????????????????????????????
   ? POST /api/NotasFiscais                 ?
   ? Body: { numeroNFSE: "123", ... }       ?
   ??????????????????????????????????????????
                    ?
                    ?
2. API Layer
   ??????????????????????????????????????????
   ? NotasFiscaisController                 ?
   ?  • Validates request                   ?
   ?  • Calls service                       ?
   ??????????????????????????????????????????
                    ?
                    ?
3. Application Layer
   ??????????????????????????????????????????
   ? NotaFiscalService                      ?
   ?  • Business rules                      ?
   ?  • Calculations                        ?
   ?  • Calls repository                    ?
   ??????????????????????????????????????????
                    ?
                    ?
4. Infrastructure Layer
   ??????????????????????????????????????????
   ? NotaFiscalRepository                   ?
   ?  • Converts to MongoDB format          ?
   ?  • Saves to database                   ?
   ??????????????????????????????????????????
                    ?
                    ?
5. Database
   ??????????????????????????????????????????
   ? MongoDB                                ?
   ?  • Persists data                       ?
   ??????????????????????????????????????????
```

---

## Layer Responsibilities Matrix

| Layer | Can Use | Cannot Use | Main Responsibility |
|-------|---------|------------|-------------------|
| **Domain** | Nothing | Everything | Business entities, rules, contracts |
| **Application** | Domain | Infrastructure, API | Use cases, orchestration |
| **Infrastructure** | Domain | Application, API | Data access, external services |
| **API** | Application, Infrastructure (DI) | Direct DB access | HTTP endpoints, routing |

---

## File Organization

```
Plantonize.NotasFiscais/
?
??? ?? API/                          ? Presentation Layer
?   ??? Controllers/
?   ?   ??? NotasFiscaisController.cs
?   ?   ??? FaturasController.cs
?   ?   ??? ...
?   ??? Program.cs
?   ??? appsettings.json
?
??? ?? Application/                  ? Use Cases Layer
?   ??? Services/
?   ?   ??? NotaFiscalService.cs    ? Business Logic
?   ?   ??? FaturaService.cs
?   ?   ??? ...
?   ??? DTOs/
?   ??? Extensions/
?
??? ?? Domain/                       ? ? Core Layer
?   ??? Entities/
?   ?   ??? NotaFiscal.cs           ? Business Entities
?   ?   ??? Fatura.cs
?   ?   ??? ...
?   ??? Interfaces/
?   ?   ??? INotaFiscalService.cs   ? Contracts
?   ?   ??? INotaFiscalRepository.cs
?   ?   ??? ...
?   ??? Enum/
?       ??? StatusNFSEEnum.cs
?       ??? ...
?
??? ?? Infrastructure/               ? External Layer
?   ??? Repositories/
?   ?   ??? NotaFiscalRepository.cs ? Data Access
?   ?   ??? ...
?   ??? Services/
?   ?   ??? ServiceBusService.cs    ? External Services
?   ?   ??? ...
?   ??? Configuration/
?   ??? NotasFiscaisDBContext.cs
?
??? ?? ArchitectureTests/            ? Tests
    ??? LayerDependencyTests.cs
    ??? NamingConventionTests.cs
    ??? ...
```

---

## Architecture Tests Coverage

```
??????????????????????????????????????????????????????????????
?                    TEST CATEGORIES                         ?
??????????????????????????????????????????????????????????????

1. ? Layer Dependencies (6 tests)
   ??? Ensures layers don't depend on wrong layers

2. ? Naming Conventions (6 tests)
   ??? Enforces consistent naming patterns

3. ? Domain Layer Rules (6 tests)
   ??? Validates domain purity

4. ? Application Layer Rules (5 tests)
   ??? Validates service implementation

5. ? Infrastructure Layer Rules (6 tests)
   ??? Validates repository implementation

6. ? API Layer Rules (5 tests)
   ??? Validates controller best practices

Total: 24 Automated Tests protecting architecture!
```

---

## Clean Architecture Benefits

```
???????????????????????????????????????????????????????????
?                    BENEFITS                             ?
???????????????????????????????????????????????????????????

? Testability
   ??? Business logic isolated, easy to unit test

? Independence
   ??? Domain doesn't depend on frameworks or DBs

? Maintainability
   ??? Clear separation makes changes easier

? Flexibility
   ??? Can swap MongoDB for SQL Server easily

? Business Focus
   ??? Domain layer reflects business rules clearly

? Team Scalability
   ??? Teams can work on different layers
```

---

## Clean Architecture vs Vertical Slice

### Clean Architecture (Current)
```
Features cut across layers horizontally:

NotaFiscal Feature:
API ? Application ? Domain ? Infrastructure
?        ?           ?          ?
Controller Service  Entity   Repository
```

### Vertical Slice (Alternative)
```
Features are vertical:

Features/NotasFiscais/
??? Create/
?   ??? Command
?   ??? Handler
?   ??? Endpoint
??? Update/
    ??? Command
    ??? Handler
    ??? Endpoint
```

### When to Use Each?

| Use Clean Architecture | Use Vertical Slice |
|----------------------|-------------------|
| Shared domain logic | Feature-specific logic |
| Multiple features reuse same code | Minimal code reuse |
| Complex business rules | Simple CRUD operations |
| Large enterprise apps | MVPs, prototypes |

---

## Data Flow Diagram

### Read Operation (GET)

```
Client
  ?
  ? 1. GET /api/NotasFiscais/123
  ?
???????????????????????
? NotasFiscaisController
? (API Layer)         ?
???????????????????????
           ? 2. GetByIdAsync(id)
           ?
???????????????????????
? NotaFiscalService   ?
? (Application Layer) ?
???????????????????????
           ? 3. GetByIdAsync(id)
           ?
???????????????????????
? NotaFiscalRepository?
? (Infrastructure)    ?
???????????????????????
           ? 4. Query
           ?
???????????????????????
?     MongoDB         ?
???????????????????????
           ? 5. Returns Entity
           ?
      (Same path back)
           ?
           ?
        Client
```

### Write Operation (POST)

```
Client
  ?
  ? 1. POST /api/NotasFiscais
  ?    Body: { ... }
  ?
???????????????????????
? NotasFiscaisController
?  • Validate Model   ?
???????????????????????
           ? 2. CreateAsync(notaFiscal)
           ?
???????????????????????
? NotaFiscalService   ?
?  • Business Rules   ?
?  • Calculations     ?
?  • Validations      ?
???????????????????????
           ? 3. AddAsync(notaFiscal)
           ?
???????????????????????
? NotaFiscalRepository?
?  • Map to MongoDB   ?
?  • Insert           ?
???????????????????????
           ? 4. Insert
           ?
???????????????????????
?     MongoDB         ?
???????????????????????
           ? 5. Returns Created Entity
           ?
???????????????????????
? ServiceBusService   ?
?  • Publish Event    ?
???????????????????????
           ?
           ?
    Azure Service Bus
```

---

## Domain-Driven Design Alignment

```
??????????????????????????????????????????????????????????
?          DDD Concepts in This Architecture             ?
??????????????????????????????????????????????????????????

Domain Layer:
  ??? Entities (NotaFiscal, Fatura)
  ?   ??? Rich domain models with behavior
  ?
  ??? Value Objects (could be added)
  ?   ??? e.g., Address, Money
  ?
  ??? Domain Services (in interfaces)
      ??? Business logic that doesn't fit in entities

Application Layer:
  ??? Application Services
      ??? Orchestrate domain objects
      ??? Implement use cases

Infrastructure Layer:
  ??? Repositories
      ??? Persist and retrieve aggregates
```

---

## Testing Strategy

```
??????????????????????????????????????????????????????????
?                  TESTING PYRAMID                       ?
??????????????????????????????????????????????????????????

                    ?
                   ? ?
                  ?   ?
                 ? E2E ?
                ?????????
               ?         ?
              ?  Integr.  ?
             ???????????????
            ?               ?
           ?  Unit Tests     ?
          ????????????????????
         ?  Architecture Tests?
        ??????????????????????????

1. Architecture Tests (? Implemented)
   ??? 24 tests ensuring design rules

2. Unit Tests (Recommended)
   ??? Domain logic
   ??? Services
   ??? Validators

3. Integration Tests (Recommended)
   ??? API endpoints
   ??? Database operations
   ??? Service Bus

4. E2E Tests (Optional)
   ??? Full user scenarios
```

---

## Summary

? **Clean Architecture** - Implemented and documented  
? **24 Architecture Tests** - Enforcing design rules  
? **Clear Layers** - Domain, Application, Infrastructure, API  
? **Dependency Inversion** - Inner layers don't know outer layers  
? **Vertical Slice Option** - Alternative documented for specific cases  
? **Visual Documentation** - Diagrams and flowcharts  

**Your architecture is solid, tested, and ready to scale!** ??

---

For more details, see:
- [README.md](./README.md) - Complete documentation
- [ARCHITECTURE_TESTS_REFERENCE.md](./ARCHITECTURE_TESTS_REFERENCE.md) - Test guide
- [VERTICAL_SLICE_GUIDE.md](./VERTICAL_SLICE_GUIDE.md) - Alternative approach
